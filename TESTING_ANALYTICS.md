# Analytics Agent Testing Guide

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

```powershell
python server.py
```

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π LangChain.

### 2. –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç–æ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## –ú–µ—Ç–æ–¥ 1: –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç-—Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `test_analytics_simple.py`:

```powershell
python test_analytics_simple.py
```

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
- –†–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –∑–∞–ø—Ä–æ—Å–æ–≤ (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –¥–∏–∞–≥—Ä–∞–º–º—ã, –æ—Ç—á–µ—Ç—ã)
- –†–∞–∑–Ω—ã–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—ã —É–≤–∏–¥–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥ –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞ —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –æ—Ç–≤–µ—Ç–æ–≤.

---

## –ú–µ—Ç–æ–¥ 2: –ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ (—Å Rich library)

–ï—Å–ª–∏ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `rich`:

```powershell
pip install rich
python test_analytics_manual.py
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –¶–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON
- –ü–æ–¥—Å–≤–µ—Ç–∫–∞ SQL —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
- –¢–∞–±–ª–∏—Ü–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏

---

## –ú–µ—Ç–æ–¥ 3: Pytest (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

–î–ª—è CI/CD –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

```powershell
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pytest –µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
pip install pytest

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ —Ç–µ—Å—Ç—ã Analytics Agent
pytest tests/test_analytics_endpoint.py -v

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç
pytest tests/test_analytics_endpoint.py::TestAnalyticsBasic::test_simple_statistics_query -v

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
pytest tests/test_analytics_endpoint.py -vv -s
```

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ë–∞–∑–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
- RBAC (—Ä–∞–∑–Ω—ã–µ —Ä–æ–ª–∏)
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞
- Pydantic –º–æ–¥–µ–ª–∏
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ LangChain warnings

---

## –ú–µ—Ç–æ–¥ 4: –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ PowerShell

### –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å:

```powershell
Invoke-RestMethod -Uri "http://localhost:8000/api/analytics" `
  -Method POST `
  -ContentType "application/json" `
  -Body '{"query": "–ü–æ–∫–∞–∂–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–µ–∫—Ç–æ–≤", "user_role": "admin"}'
```

### –° —Ñ–∏–ª—å—Ç—Ä–∞–º–∏:

```powershell
Invoke-RestMethod -Uri "http://localhost:8000/api/analytics" `
  -Method POST `
  -ContentType "application/json" `
  -Body '{"query": "–ü–æ–∫–∞–∂–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã", "user_role": "admin"}'
```

### –î–∏–∞–≥—Ä–∞–º–º–∞:

```powershell
Invoke-RestMethod -Uri "http://localhost:8000/api/analytics" `
  -Method POST `
  -ContentType "application/json" `
  -Body '{"query": "–°–æ–∑–¥–∞–π –∫—Ä—É–≥–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º", "user_role": "admin"}'
```

---

## –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å

### ‚úÖ –£—Å–ø–µ—à–Ω—ã–π —Ç–µ—Å—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å:

1. **Status 200 OK**
2. **–ù–µ—Ç LangChain warnings** –≤ –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞:
   ```
   ‚ùå –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   UserWarning: Invalid schema for OpenAI's structured output feature...
   ```

3. **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:**
   ```json
   {
     "type": "chart",
     "content": "üìä –î–∏–∞–≥—Ä–∞–º–º–∞...",
     "sql_query": "SELECT ...",
     "chart_config": { "type": "pie", ... },
     "metadata": { "row_count": 2 },
     "success": true
   }
   ```

4. **FilterOptions —Ä–∞–±–æ—Ç–∞–µ—Ç:**
   –í –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   ```
   Parsed query: intent='chart' ... filters=FilterOptions(status=None, ...)
   ```
   (–Ω–µ dict, –∞ FilterOptions!)

### ‚ùå –ü—Ä–æ–±–ª–µ–º—ã:

- **Connection Error** ‚Üí –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω
- **Status 400** ‚Üí –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
- **Status 500** ‚Üí –û—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ –∞–≥–µ–Ω—Ç–∞
- **LangChain warning** ‚Üí Pydantic –º–æ–¥–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ

---

## –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```
"–ü–æ–∫–∞–∂–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–µ–∫—Ç–æ–≤"
"–°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤?"
"–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
```

### –î–∏–∞–≥—Ä–∞–º–º—ã
```
"–°–æ–∑–¥–∞–π –∫—Ä—É–≥–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –ø—Ä–æ–µ–∫—Ç–æ–≤"
"–ü–æ–∫–∞–∂–∏ –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞"
"–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º"
```

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
```
"–ü–æ–∫–∞–∂–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã"
"–ü—Ä–æ–µ–∫—Ç—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü"
"–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã"
```

### –û—Ç—á–µ—Ç—ã
```
"–°—Ñ–æ—Ä–º–∏—Ä—É–π –æ—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É"
"–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º"
"–û—Ç—á–µ—Ç –ø–æ —ç—Ç–∞–ø–∞–º"
```

### SQL
```
"–ù–∞–ø–∏—à–∏ SQL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤"
"SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"
"–ü–æ–∫–∞–∂–∏ –∑–∞–ø—Ä–æ—Å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏"
```

---

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: `ModuleNotFoundError: No module named 'rich'`

**–†–µ—à–µ–Ω–∏–µ:**
```powershell
pip install rich
```
–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `test_analytics_simple.py` –≤–º–µ—Å—Ç–æ `test_analytics_manual.py`

### –ü—Ä–æ–±–ª–µ–º–∞: `Connection Error`

**–†–µ—à–µ–Ω–∏–µ:**
–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:
```powershell
python server.py
```

### –ü—Ä–æ–±–ª–µ–º–∞: –í–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞–∫–∏ –≤ –ª–æ–≥–∞—Ö

```
query='?????? ???????? ???????'
```

**–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ!** –≠—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –≤ Windows –∫–æ–Ω—Å–æ–ª–∏.
–°–∞–º –∑–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ `intent='chart'` –∏ –¥—Ä—É–≥–∏–µ parsed –ø–æ–ª—è).

–î–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ–±–∞–≤—å—Ç–µ –≤ `server.py`:
```python
import sys, codecs
if sys.platform == 'win32':
    sys.stdout = codecs.getwriter('utf-8')(sys.stdout.buffer, 'strict')
```

### –ü—Ä–æ–±–ª–µ–º–∞: LangChain warning –≤—Å—ë –µ—â–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. –ï—Å—Ç—å –ª–∏ `ConfigDict` –≤ –∏–º–ø–æ—Ä—Ç–∞—Ö? (—Å—Ç—Ä–æ–∫–∞ 4)
   ```python
   from pydantic import BaseModel, Field, ConfigDict
   ```

2. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ `model_config` –≤ FilterOptions? (—Å—Ç—Ä–æ–∫–∞ 14)
   ```python
   model_config = ConfigDict(extra="forbid")
   ```

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª–∏ –ª–∏ –≤—ã —Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π?

---

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –£—Å–ø–µ—à–Ω—ã–π —Ç–µ—Å—Ç –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

```
================================================================================
Test 1/4
================================================================================
Query: –ü–æ–∫–∞–∂–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–µ–∫—Ç–æ–≤
Role: admin
================================================================================
Status: 200

‚úÖ SUCCESS

Type: table
Success: True

üìù Content:
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤:
...

üíæ SQL Query:
SELECT p.id, p.name, p.status, COUNT(DISTINCT s.id) as stages_count...

üìã Metadata:
  row_count: 2
  execution_time_ms: 15

Press Enter for next test...
```

### –í –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ (–ë–ï–ó warnings):

```
INFO | analytics_endpoint | üìä Received analytics request: query='??????...'
INFO | AnalyticsAgent initialized with model gpt-4o
INFO | Parsed query: intent='report' entities=['projects'] filters=FilterOptions(...)
INFO | Executing SQL: SELECT...
INFO | Analytics result generated: type=table, rows=2
INFO | 127.0.0.1 - "POST /api/analytics HTTP/1.1" 200 OK
```

**–ì–ª–∞–≤–Ω–æ–µ:** –ù–ï–¢ —Å—Ç—Ä–æ–∫ —Å `UserWarning: Invalid schema...` ‚úÖ

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤ –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ:
- ‚úÖ Analytics Agent —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ standalone —Å–µ—Ä–≤–∏—Å
- ‚úÖ Pydantic v2 FilterOptions –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- ‚úÖ OpenAI structured output —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ warnings
- ‚úÖ –í—Å–µ —Ç–∏–ø—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ RBAC –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç
